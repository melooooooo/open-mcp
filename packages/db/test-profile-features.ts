import * as dotenv from "dotenv"
import * as path from "path"
import { Pool } from "pg"

dotenv.config({ path: path.resolve(__dirname, "../../.env.local") })
dotenv.config({ path: path.resolve(__dirname, "../../.env") })

async function testProfileFeatures() {
  const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
  })

  try {
    console.log("=".repeat(60))
    console.log("ä¸ªäººä¸­å¿ƒåŠŸèƒ½æµ‹è¯•")
    console.log("=".repeat(60))

    // 1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
    console.log("\n1ï¸âƒ£  æ£€æŸ¥æ•°æ®åº“è¿æ¥...")
    await pool.query('SELECT 1')
    console.log("   âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸")

    // 2. éªŒè¯æ–°å­—æ®µå­˜åœ¨
    console.log("\n2ï¸âƒ£  éªŒè¯æ–°å­—æ®µ...")
    const fields = await pool.query(`
      SELECT column_name, data_type, is_nullable 
      FROM information_schema.columns 
      WHERE table_name = 'user' 
      AND column_name IN ('gender', 'address', 'contact_phone')
      ORDER BY column_name
    `)

    fields.rows.forEach(field => {
      console.log(`   âœ… ${field.column_name}: ${field.data_type} (nullable: ${field.is_nullable})`)
    })

    // 3. æµ‹è¯•æŸ¥è¯¢ç”¨æˆ·æ•°æ®(æ¨¡æ‹Ÿ page.tsx)
    console.log("\n3ï¸âƒ£  æµ‹è¯•ç”¨æˆ·æ•°æ®æŸ¥è¯¢...")
    const users = await pool.query(`
      SELECT id, name, email, gender, address, contact_phone 
      FROM "user" 
      LIMIT 1
    `)

    if (users.rows.length > 0) {
      const user = users.rows[0]
      console.log("   âœ… æˆåŠŸæŸ¥è¯¢åˆ°ç”¨æˆ·æ•°æ®")
      console.log(`   ç”¨æˆ·: ${user.name} (${user.email})`)
      console.log(`   æ€§åˆ«: ${user.gender || 'æœªè®¾ç½®'}`)
      console.log(`   åœ°å€: ${user.address || 'æœªè®¾ç½®'}`)
      console.log(`   è”ç³»ç”µè¯: ${user.contact_phone || 'æœªè®¾ç½®'}`)
    } else {
      console.log("   âš ï¸  æ•°æ®åº“ä¸­æš‚æ— ç”¨æˆ·æ•°æ®")
    }

    // 4. æµ‹è¯•æ›´æ–°æ“ä½œ(æ¨¡æ‹Ÿ updateProfile action)
    console.log("\n4ï¸âƒ£  æµ‹è¯•æ›´æ–°æ“ä½œ...")
    if (users.rows.length > 0) {
      const userId = users.rows[0].id
      const testData = {
        gender: 'male',
        address: 'æµ‹è¯•åœ°å€',
        contact_phone: '13800138000'
      }

      await pool.query(`
        UPDATE "user" 
        SET gender = $1, address = $2, contact_phone = $3 
        WHERE id = $4
      `, [testData.gender, testData.address, testData.contact_phone, userId])

      console.log("   âœ… æ›´æ–°æ“ä½œæˆåŠŸ")

      // éªŒè¯æ›´æ–°
      const updated = await pool.query(`
        SELECT gender, address, contact_phone 
        FROM "user" 
        WHERE id = $1
      `, [userId])

      const updatedUser = updated.rows[0]
      console.log(`   éªŒè¯: æ€§åˆ«=${updatedUser.gender}, åœ°å€=${updatedUser.address}, ç”µè¯=${updatedUser.contact_phone}`)

      // æ¢å¤åŸå§‹æ•°æ®
      await pool.query(`
        UPDATE "user" 
        SET gender = $1, address = $2, contact_phone = $3 
        WHERE id = $4
      `, [users.rows[0].gender, users.rows[0].address, users.rows[0].contact_phone, userId])

      console.log("   âœ… å·²æ¢å¤åŸå§‹æ•°æ®")
    }

    console.log("\n" + "=".repeat(60))
    console.log("âœ… æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡!")
    console.log("=".repeat(60))
    console.log("\nğŸ“‹ åŠŸèƒ½æ¸…å•:")
    console.log("  âœ… æ•°æ®åº“å­—æ®µå·²æ·»åŠ ")
    console.log("  âœ… æŸ¥è¯¢ç”¨æˆ·æ•°æ®æ­£å¸¸")
    console.log("  âœ… æ›´æ–°æ“ä½œæ­£å¸¸")
    console.log("\nğŸ¯ å‰ç«¯åŠŸèƒ½:")
    console.log("  - è®¿é—® http://localhost:30001/user/profile")
    console.log("  - æŸ¥çœ‹åªæœ‰'æ”¶è—'å’Œ'ç‚¹èµ'ä¸¤ä¸ªæ ‡ç­¾")
    console.log("  - ç‚¹å‡»'ç¼–è¾‘èµ„æ–™'æŒ‰é’®")
    console.log("  - ä¿®æ”¹æ€§åˆ«ã€åœ°å€ã€è”ç³»ç”µè¯")
    console.log("  - ä¿å­˜å¹¶éªŒè¯æ›´æ–°")

  } catch (error: any) {
    console.error("\nâŒ æµ‹è¯•å¤±è´¥!")
    console.error("é”™è¯¯:", error.message)
  } finally {
    await pool.end()
    process.exit(0)
  }
}

testProfileFeatures()
